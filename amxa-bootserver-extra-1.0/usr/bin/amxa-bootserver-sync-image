#!/bin/sh




if test -z "$1"; then
  echo "usage: $0 workingdirectoory"
  exit
fi

SSH="ssh -p443 -i/root/yourfilehere "
HOST="root@hadar.amxa.ch"


cd $1


if ! test -d ./rdiffs; then
 mkdir rdiffs
fi
if ! test -d ./meta; then
 mkdir meta
fi

#HEAD=$(find . -name "ltsp-amxa*img"|head -n1)

#local
HEAD=$(ls -r ltsp-amxa*img|head -n1)
ALL_IMAGES=$(ls -r ltsp-amxa-*-i386.img)

#remote
RHEAD=$($SSH $HOST ls -r "/home/images/www/*img|head -n1")
RHEAD=$(basename $RHEAD)
#DATE=$(echo $HEAD|cut -d- -f4-7)
RRDIFS=$($SSH $HOST ls -r "/home/images/www/*img|head -n1")

echo "$HEAD *************** $RHEAD"


#exit

echo "updating image................................................"
#rsync -vr --progress root@hadar.amxa.ch:/home/images/www/CKSUMS .
#rsync -vr --progress root@hadar.amxa.ch:/home/images/www/meta/ ./meta/

if test "$HEAD" = "$RHEAD"; then
  echo "same image, exiting ..."
  exit 0
fi


if ! test  -e $RHEAD.ok ; then
   echo -n "updating image "
   rsync -vr --progress -e"$SSH"  $HOST:/home/images/www/rdiffs/  ./rdiffs/

   if ! rsync -v --progress -e"$SSH" $HOST:/home/images/www/$RHEAD.sha256 .;then
     exit 1
   fi
   if ! rsync -v --progress -e"$SSH" $HOST:/home/images/www/$RHEAD.cksum .; then
     exit 1
   fi

   RDIFF=$(amxa-rdiff-filename $HEAD $RHEAD)
   FOUND=0
   for RD in $(ls ./rdiffs); do
     RD=$(basename $RD)
     if test "$RDIFF" = "$RD";then
       FOUND=1
     fi
   done

   if test $FOUND = "1"; then
     echo "using rdiff ..."
     rdiff patch ./$HEAD ./rdiffs/$RDIFF ./$RHEAD
  else
     echo "using rsync ..."
     if ! test -e "$RHEAD"; then
        cp ./$HEAD ./$RHEAD
     fi
     rsync -vP -e"$SSH"  $HOST:/home/images/www/$RHEAD  .
  fi
echo "amxa-generate-all-rdiffs"
  amxa-generate-all-rdiffs 
echo "amxa-generate-cksums ."
  amxa-generate-cksums .
  echo "CKSUMS updated"
  amxa-generate-images-meta . one >./meta/ltsp-amxa-trusty-i386.json
  echo "meta/ltsp-amxa-trusty-i386.json updated"
  

  if $(sha256sum --quiet --check $RHEAD.sha256); then
      touch ./$RHEAD.ok
  else
      echo "An error occurred! Exiting..."
      exit 1
  fi
  echo "ok, remote is now up to date"
else
  echo "remote is allready up to date"
fi
